<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pro Notes iOS Final</title>
<style>
    :root {
        --bg: #f2f2f7; --card: #ffffff; --text: #000000;
        --accent: #007aff; --orange: #ff9500; --red: #ff3b30;
        --sheet-bg: rgba(245, 245, 247, 0.98);
        --btn-grey: #e5e5ea; --btn-text: #000;
        --border: #c6c6c8; --blur: blur(20px);
    }
    [data-theme="dark"] {
        --bg: #000000; --card: #1c1c1e; --text: #ffffff;
        --sheet-bg: rgba(30, 30, 30, 0.98);
        --btn-grey: #3a3a3c; --btn-text: #fff;
        --border: #38383a;
    }

    * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    body {
        margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        background: var(--bg); color: var(--text); height: 100vh; overflow: hidden;
        display: flex; flex-direction: column;
    }

    /* --- EDITOR DE NOTAS --- */
    .editor-area { flex: 1; display: flex; flex-direction: column; padding: 20px 20px 110px 20px; }
    
    input#titleInput {
        background: transparent; border: none; font-size: 2.2rem; font-weight: 700;
        color: var(--text); outline: none; margin-bottom: 15px; width: 100%;
    }
    textarea#noteBody {
        flex: 1; background: transparent; border: none; font-size: 1.2rem; line-height: 1.6;
        color: var(--text); outline: none; resize: none;
    }

    /* --- BARRA DE NAVEGA√á√ÉO (DOCK) --- */
    .dock-bar {
        position: fixed; bottom: 30px; left: 20px; right: 20px;
        background: var(--sheet-bg); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
        padding: 10px 15px; border-radius: 45px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 1px solid rgba(128,128,128,0.2); z-index: 100;
    }
    .dock-btn {
        width: 50px; height: 50px; border-radius: 50%; border: none;
        background: transparent; color: var(--accent); font-size: 1.5rem;
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        transition: transform 0.1s;
    }
    .dock-btn:active { transform: scale(0.9); background: rgba(128,128,128,0.15); }
    .dock-btn.main-action { background: var(--accent); color: #fff; box-shadow: 0 4px 12px rgba(0,122,255,0.4); }

    /* --- JANELAS DESLIZANTES (SHEETS) --- */
    .overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .overlay.active { opacity: 1; pointer-events: auto; }
    
    .sheet {
        position: absolute; bottom: 0; left: 0; right: 0;
        background: var(--sheet-bg); border-radius: 30px 30px 0 0;
        transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.1);
        display: flex; flex-direction: column; max-height: 95vh;
        backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .overlay.active .sheet { transform: translateY(0); }
    
    .handle-area { width: 100%; padding: 15px 0; display: flex; justify-content: center; flex-shrink: 0; }
    .handle-bar { width: 40px; height: 5px; background: var(--border); border-radius: 10px; opacity: 0.8; }

    /* --- CALCULADORA --- */
    .calc-container { padding: 0 20px 40px 20px; display: flex; flex-direction: column; align-items: center; }
    
    /* Visor */
    .display-wrapper { width: 100%; text-align: right; margin-bottom: 10px; }
    #calcResult {
        width: 100%; text-align: right; font-size: 3.5rem; border: none;
        background: transparent; color: var(--text); font-weight: 300; outline: none; margin: 0;
    }
    
    /* Hist√≥rico Dropdown */
    .history-dropdown {
        width: 100%; background: rgba(128,128,128,0.1); border-radius: 15px;
        max-height: 0; overflow-y: auto; transition: max-height 0.3s ease;
        margin-bottom: 10px;
    }
    .history-dropdown.open { max-height: 150px; padding: 10px; border: 1px solid var(--border); }
    .hist-entry { 
        text-align: right; padding: 8px; border-bottom: 1px solid rgba(128,128,128,0.1); 
        font-size: 1.1rem; color: var(--text);
    }
    .hist-entry:last-child { border-bottom: none; }

    /* Bot√µes de Controlo Texto */
    .calc-tools { width: 100%; display: flex; justify-content: space-between; margin-bottom: 15px; padding: 0 5px; }
    .tool-btn { background: none; border: none; font-weight: 600; font-size: 0.95rem; color: var(--accent); padding: 5px; }

    /* Bot√µes Cient√≠ficos */
    .sci-row { 
        display: none; grid-template-columns: repeat(5, 1fr); gap: 8px; 
        width: 100%; margin-bottom: 10px; 
    }
    .sci-row.show { display: grid; }
    .sci-btn { 
        height: 40px; border-radius: 10px; border: none; 
        background: var(--btn-grey); color: var(--text); font-size: 0.8rem; font-weight: 600;
    }

    /* Grid Num√©rico Principal */
    .keypad { 
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; 
        width: 100%; max-width: 380px; /* Previne que fiquem muito separados */
    }
    .key-btn {
        aspect-ratio: 1/1; /* Garante C√çRCULO PERFEITO */
        width: 100%; max-width: 75px; 
        border-radius: 50%; border: none; font-size: 1.7rem;
        background: var(--btn-grey); color: var(--btn-text);
        display: flex; align-items: center; justify-content: center;
        margin: 0 auto; /* Centrar na c√©lula */
    }
    .key-btn:active { filter: brightness(0.85); }
    .key-btn.orange { background: var(--orange); color: #fff; }
    .key-btn.wide { 
        grid-column: span 2; width: 100%; max-width: none; 
        aspect-ratio: auto; height: 75px; border-radius: 40px; 
        justify-content: flex-start; padding-left: 30px; 
    }

    /* --- LISTA DE NOTAS --- */
    .list-container { padding: 0 20px 40px 20px; overflow-y: auto; height: 70vh; width: 100%; }
    .note-card {
        background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
    }
    .note-card-text { flex: 1; overflow: hidden; }
    .note-card h4 { margin: 0 0 4px 0; font-size: 1rem; }
    .note-card p { margin: 0; color: #8e8e93; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-trash {
        background: rgba(255, 59, 48, 0.1); color: var(--red); border: none;
        width: 35px; height: 35px; border-radius: 50%; margin-left: 10px;
        display: flex; align-items: center; justify-content: center;
    }

</style>
</head>
<body data-theme="light">

    <div class="editor-area">
        <input type="text" id="titleInput" placeholder="T√≠tulo">
        <textarea id="noteBody" placeholder="Escreve aqui..."></textarea>
    </div>

    <div class="dock-bar">
        <button class="dock-btn" id="btnTheme">‚óë</button>
        <button class="dock-btn" id="btnClear">‚úï</button>
        <button class="dock-btn main-action" id="btnOpenCalc">üßÆ</button>
        <button class="dock-btn" id="btnSave">üíæ</button>
        <button class="dock-btn" id="btnList">‚ò∞</button>
    </div>

    <div class="overlay" id="modalCalc">
        <div class="sheet">
            <div class="handle-area"><div class="handle-bar"></div></div>
            <div class="calc-container">
                
                <div class="history-dropdown" id="historyList"></div>

                <div class="display-wrapper">
                    <input id="calcResult" readonly value="0">
                </div>

                <div class="calc-tools">
                    <button class="tool-btn" id="btnShowHist">üïí Hist√≥rico</button>
                    <button class="tool-btn" id="btnToggleSci">Cient√≠fica</button>
                    <button class="tool-btn" style="color:var(--orange)" id="btnPaste">Inserir na Nota</button>
                </div>

                <div class="sci-row" id="sciRow">
                    <button class="sci-btn" onclick="sci('sin')">sin</button>
                    <button class="sci-btn" onclick="sci('cos')">cos</button>
                    <button class="sci-btn" onclick="sci('tan')">tan</button>
                    <button class="sci-btn" onclick="sci('log')">log</button>
                    <button class="sci-btn" onclick="sci('sqrt')">‚àö</button>
                    <button class="sci-btn" onclick="ins('(')">(</button>
                    <button class="sci-btn" onclick="ins(')')">)</button>
                    <button class="sci-btn" onclick="sci('pow')">x¬≤</button>
                    <button class="sci-btn" onclick="ins('3.1415')">œÄ</button>
                    <button class="sci-btn" onclick="ins('2.7182')">e</button>
                </div>

                <div class="keypad">
                    <button class="key-btn" style="background:#d4d4d2;color:#000" onclick="cls()">AC</button>
                    <button class="key-btn" style="background:#d4d4d2;color:#000" onclick="del()">‚å´</button>
                    <button class="key-btn" style="background:#d4d4d2;color:#000" onclick="ins('%')">%</button>
                    <button class="key-btn orange" onclick="ins('/')">√∑</button>

                    <button class="key-btn" onclick="ins('7')">7</button>
                    <button class="key-btn" onclick="ins('8')">8</button>
                    <button class="key-btn" onclick="ins('9')">9</button>
                    <button class="key-btn orange" onclick="ins('*')">√ó</button>

                    <button class="key-btn" onclick="ins('4')">4</button>
                    <button class="key-btn" onclick="ins('5')">5</button>
                    <button class="key-btn" onclick="ins('6')">6</button>
                    <button class="key-btn orange" onclick="ins('-')">‚àí</button>

                    <button class="key-btn" onclick="ins('1')">1</button>
                    <button class="key-btn" onclick="ins('2')">2</button>
                    <button class="key-btn" onclick="ins('3')">3</button>
                    <button class="key-btn orange" onclick="ins('+')">+</button>

                    <button class="key-btn wide" onclick="ins('0')">0</button>
                    <button class="key-btn" onclick="ins('.')">,</button>
                    <button class="key-btn orange" onclick="calculate()">=</button>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="modalList">
        <div class="sheet">
            <div class="handle-area"><div class="handle-bar"></div></div>
            <div class="list-container">
                <h2 style="margin-top:0">Notas Guardadas</h2>
                <div id="notesContainer"></div>
            </div>
        </div>
    </div>

<script>
    // --- ELEMENTOS GLOBAIS ---
    const titleInput = document.getElementById('titleInput');
    const noteBody = document.getElementById('noteBody');
    const display = document.getElementById('calcResult');
    const historyList = document.getElementById('historyList');
    
    // Arrays para guardar dados
    let savedNotes = JSON.parse(localStorage.getItem('appNotes') || '[]');
    let calcHistory = [];

    // --- TEMA E UI GERAL ---
    document.getElementById('btnTheme').onclick = () => {
        const theme = document.body.dataset.theme === 'light' ? 'dark' : 'light';
        document.body.dataset.theme = theme;
    };
    
    document.getElementById('btnClear').onclick = () => {
        if(confirm("Limpar editor?")) { titleInput.value = ''; noteBody.value = ''; }
    };

    // --- MOTOR DA CALCULADORA ---
    function ins(v) {
        if(display.value === '0' && !isNaN(v)) display.value = '';
        if(display.value === 'Erro') display.value = '';
        display.value += v;
    }
    
    function cls() { 
        display.value = '0'; 
    }
    
    function del() { 
        display.value = display.value.length > 1 ? display.value.slice(0, -1) : '0'; 
    }

    // L√ìGICA DE C√ÅLCULO FINANCEIRO (CORRIGIDA)
    function calculate() {
        try {
            let expr = display.value.replace(/√ó/g, '*').replace(/√∑/g, '/');
            let result;

            // Regex para capturar: N√∫mero + Operador + Percentagem
            // Ex: 50 + 10%
            const percentPattern = /([0-9.]+)[\+\-]([0-9.]+)%/;

            if (expr.includes('%')) {
                // Caso 1: Soma/Subtra√ß√£o com percentagem (Ex: 5 + 10%)
                if (percentPattern.test(expr)) {
                    // Divide a express√£o para encontrar o operador
                    let operator = expr.includes('+') ? '+' : '-';
                    let parts = expr.split(operator);
                    let base = parseFloat(parts[0]);
                    let percent = parseFloat(parts[1].replace('%', ''));
                    
                    let valueOfPercent = base * (percent / 100);
                    
                    if (operator === '+') result = base + valueOfPercent;
                    if (operator === '-') result = base - valueOfPercent;
                } 
                // Caso 2: Multiplica√ß√£o/Divis√£o ou Percentagem simples (Ex: 50 * 10% ou 10%)
                else {
                    let cleanExpr = expr.replace(/([0-9.]+)%/g, '($1/100)');
                    result = eval(cleanExpr);
                }
            } else {
                // C√°lculo normal
                result = eval(expr);
            }
            
            // Arredondar se tiver muitas casas decimais
            if (!Number.isInteger(result)) result = parseFloat(result.toFixed(4));
            
            // Adicionar ao hist√≥rico
            addToHistory(display.value, result);
            display.value = result;

        } catch (e) {
            display.value = 'Erro';
        }
    }

    function sci(func) {
        try {
            let val = eval(display.value);
            let res;
            if (func === 'sqrt') res = Math.sqrt(val);
            else if (func === 'pow') res = Math.pow(val, 2);
            else res = Math[func](val);
            
            // Arredondar
            if (!Number.isInteger(res)) res = parseFloat(res.toFixed(6));
            
            addToHistory(`${func}(${val})`, res);
            display.value = res;
        } catch { display.value = 'Erro'; }
    }

    // --- GEST√ÉO DE HIST√ìRICO ---
    function addToHistory(op, res) {
        calcHistory.unshift(`${op} = ${res}`);
        if(calcHistory.length > 20) calcHistory.pop();
        renderHistory();
    }

    function renderHistory() {
        historyList.innerHTML = calcHistory.map(h => `<div class="hist-entry">${h}</div>`).join('');
    }

    // Bot√µes de Controlo da Calc (com stopPropagation)
    document.getElementById('btnShowHist').onclick = (e) => {
        e.stopPropagation();
        historyList.classList.toggle('open');
    };

    document.getElementById('btnToggleSci').onclick = (e) => {
        e.stopPropagation();
        document.getElementById('sciRow').classList.toggle('show');
    };

    document.getElementById('btnPaste').onclick = (e) => {
        e.stopPropagation(); // Previne fechar
        if(display.value !== 'Erro') {
            noteBody.value += (noteBody.value ? '\n' : '') + display.value;
            // Opcional: fechar calculadora ap√≥s inserir
            // closeModal('modalCalc'); 
        }
    };

    // --- GEST√ÉO DE NOTAS ---
    function renderNotes() {
        const container = document.getElementById('notesContainer');
        container.innerHTML = '';
        if (savedNotes.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888">Sem notas guardadas.</p>';
            return;
        }
        savedNotes.forEach(note => {
            const div = document.createElement('div');
            div.className = 'note-card';
            div.innerHTML = `
                <div class="note-card-text" onclick="loadNote(${note.id})">
                    <h4>${note.title}</h4>
                    <p>${note.body}</p>
                </div>
                <button class="btn-trash" onclick="deleteNote(${note.id})">üóë</button>
            `;
            container.appendChild(div);
        });
    }

    document.getElementById('btnSave').onclick = () => {
        if(!titleInput.value.trim() && !noteBody.value.trim()) return alert("Nota vazia!");
        const newNote = {
            id: Date.now(),
            title: titleInput.value || 'Sem T√≠tulo',
            body: noteBody.value
        };
        savedNotes.unshift(newNote);
        localStorage.setItem('appNotes', JSON.stringify(savedNotes));
        alert("Guardado!");
        titleInput.value = ''; noteBody.value = '';
    };

    window.loadNote = (id) => {
        const note = savedNotes.find(n => n.id === id);
        if(note) {
            titleInput.value = note.title;
            noteBody.value = note.body;
            closeModal('modalList');
        }
    };

    window.deleteNote = (id) => {
        if(confirm("Apagar esta nota?")) {
            savedNotes = savedNotes.filter(n => n.id !== id);
            localStorage.setItem('appNotes', JSON.stringify(savedNotes));
            renderNotes();
        }
    };

    // --- MODAL & SWIPE (L√ìGICA DO iOS) ---
    function openModal(id) {
        document.getElementById(id).classList.add('active');
        if(id === 'modalList') renderNotes();
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    document.getElementById('btnOpenCalc').onclick = () => openModal('modalCalc');
    document.getElementById('btnList').onclick = () => openModal('modalList');

    // Fechar ao clicar fora (Overlay)
    document.querySelectorAll('.overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if(e.target === overlay) closeModal(overlay.id);
        });
        
        // SWIPE GESTURE
        const sheet = overlay.querySelector('.sheet');
        let startY = 0;
        let currentY = 0;

        sheet.addEventListener('touchstart', (e) => {
            // S√≥ permitir swipe se o scroll estiver no topo
            if(sheet.scrollTop === 0) {
                startY = e.touches[0].clientY;
            }
        }, {passive: true});

        sheet.addEventListener('touchmove', (e) => {
            if(startY === 0) return;
            currentY = e.touches[0].clientY;
            const diff = currentY - startY;
            if(diff > 0) { // Arrastar para baixo
                 if(e.cancelable) e.preventDefault();
                 sheet.style.transform = `translateY(${diff}px)`;
                 sheet.style.transition = 'none';
            }
        }, {passive: false});

        sheet.addEventListener('touchend', (e) => {
            if(startY === 0) return;
            const diff = currentY - startY;
            sheet.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1)';
            
            if(diff > 120) { // Se arrastou mais de 120px, fecha
                closeModal(overlay.id);
                setTimeout(() => { sheet.style.transform = ''; }, 300);
            } else { // Se n√£o, volta para cima
                sheet.style.transform = '';
            }
            startY = 0; currentY = 0;
        });
    });

</script>
</body>
</html>











