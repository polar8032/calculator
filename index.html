<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pro Notes â€” Calculadora</title>
<style>
:root{
  --bg-main:#f2f2f7; --bg-section:#ffffff; --text:#1c1c1e; --muted:#8e8e93;
  --accent:#007aff; --orange:#ff9500; --danger:#ff3b30; --success:#34c759;
  --neutral:#8e8e93; --grey:#f2f2f7; --border:#d1d1d6; --shadow:0 8px 30px rgba(0,0,0,.2);
}
[data-theme="dark"]{
  --bg-main:#121212; --bg-section:#272729; --text:#ededed; --muted:#98989d;
  --grey:#38383a; --border:#424244; --orange:#ff9f0a;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;}
body{margin:0;background:var(--bg-main);color:var(--text);height:100vh;overflow:hidden;}
.section-notes{height:100vh;padding:16px;display:flex;flex-direction:column;background:var(--bg-section);}
#note-title{border:none;font-size:1.3rem;font-weight:700;background:none;color:var(--text);outline:none;}
textarea{flex:1;border:none;outline:none;resize:none;font-size:1.05rem;margin-top:12px;background:none;color:var(--text);padding-bottom:100px;}
.floating-actions{position:fixed;bottom:0;left:0;right:0;background:var(--bg-section);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:10px 6px;z-index:10;}
.btn-mini{width:48px;height:48px;border-radius:50%;border:none;font-size:1.2rem;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;touch-action:manipulation;}
.calc-modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;z-index:100;}
.calc-sheet{position:relative;background:var(--bg-section);width:100%;border-radius:20px 20px 0 0;padding:12px 16px 20px;box-shadow:var(--shadow);}
#calc-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.calc-title{font-weight:700;}
.close-calc{background:transparent;border:none;font-size:1.4rem;cursor:pointer;color:var(--muted);}
#calc-display{width:100%;height:60px;font-size:2rem;text-align:right;border:none;background:none;color:var(--text);margin-bottom:8px;padding-right:6px;}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.grid button{height:56px;border-radius:50%;border:none;background:var(--grey);font-size:1.05rem;cursor:pointer;touch-action:manipulation;}
.btn-op{color:var(--accent)}
.btn-orange{background:var(--orange);color:white}
.btn-blue{grid-column:span 2;border-radius:28px;background:var(--accent);color:white}
.mode-toggle{margin-left:8px;padding:6px 10px;border-radius:12px;border:none;background:transparent;cursor:pointer;font-weight:600;color:var(--accent)}
.send-btn{margin-top:12px;width:100%;padding:12px;border:none;border-radius:12px;background:var(--accent);color:white;font-weight:600;font-size:1rem;}
@media(min-width:769px){ /* nÃ£o esconder via !important - apenas reduzir o tamanho da sheet se desejado */
  .calc-sheet{max-width:480px;margin:0 auto;border-radius:12px;}
}
</style>
</head>
<body>

<div class="section-notes">
  <input id="note-title" placeholder="TÃ­tulo da nota">
  <textarea id="notes" placeholder="ComeÃ§a a escrever..."></textarea>
</div>

<div class="floating-actions">
  <button class="btn-mini" id="darkBtn" title="Dark mode">ðŸŒ™</button>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn-mini" style="background:var(--accent)" id="openCalcBtn" title="Calculadora normal">ðŸ§®</button>
    <button class="btn-mini" style="background:#6b5ce2" id="openSciCalcBtn" title="Calculadora cientÃ­fica">ðŸ”¬</button>
  </div>
  <button class="btn-mini" style="background:var(--neutral)" onclick="copy()">ðŸ“‹</button>
  <button class="btn-mini" style="background:var(--orange)" onclick="clearText()">ðŸ§¹</button>
  <button class="btn-mini" style="background:var(--danger)" onclick="deleteNote()">ðŸ—‘</button>
  <button class="btn-mini" style="background:var(--success)" onclick="save()">âœ“</button>
</div>

<!-- Modal da calculadora -->
<div class="calc-modal" id="calcModal" onclick="closeCalc(event)">
  <div class="calc-sheet" role="dialog" aria-modal="true" aria-label="Calculadora">
    <div id="calc-header">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="calc-title" id="calcModeTitle">Calculadora â€” BÃ¡sica</div>
        <button class="mode-toggle" id="toggleModeBtn">Alternar para CientÃ­fica</button>
      </div>
      <div>
        <button class="close-calc" id="closeBtn" title="Fechar">âœ•</button>
      </div>
    </div>

    <input id="calc-display" readonly aria-live="polite" />

    <div class="grid" id="calc-grid"></div>

    <button class="send-btn" id="sendBtn">Enviar para Notas</button>
  </div>
</div>

<script>
/* ELEMENTOS */
const display = document.getElementById("calc-display");
const notes = document.getElementById("notes");
const modal = document.getElementById("calcModal");
const openCalcBtn = document.getElementById("openCalcBtn");
const openSciCalcBtn = document.getElementById("openSciCalcBtn");
const toggleModeBtn = document.getElementById("toggleModeBtn");
const calcModeTitle = document.getElementById("calcModeTitle");
const closeBtn = document.getElementById("closeBtn");
const sendBtn = document.getElementById("sendBtn");
const darkBtn = document.getElementById("darkBtn");

let calcMode = "basic"; // "basic" ou "scientific"

/* DEFINIÃ‡ÃƒO DE BOTÃ•ES */
const basicButtons = [
  "C","%","Ã·","âŒ«",
  "7","8","9","Ã—",
  "4","5","6","-",
  "1","2","3","+",
  "0",".","="
];

const scientificButtons = [
  "C","%","Ã·","âŒ«",
  "sin","cos","tan","^",
  "ln","log","âˆš","(",
  "7","8","9",")",
  "4","5","6","-",
  "1","2","3","+",
  "Ï€","0",".","e",
  "="
];

/* RENDERIZA CALCULADORA CONFORME MODO */
function renderCalc(){
  const grid = document.getElementById("calc-grid");
  const list = calcMode === "basic" ? basicButtons : scientificButtons;
  grid.innerHTML = list.map(b=>{
    let cls = "";
    if ("+-Ã—=^".includes(b) || "sincos".includes(b)) cls = "btn-orange";
    if ("C%âŒ«Ã·".includes(b)) cls = "btn-op";
    if (b === "0") cls = "btn-blue";
    // para manter compatibilidade, usar onclick
    return `<button class="${cls}" onclick="press('${b}')">${b}</button>`;
  }).join("");
  calcModeTitle.textContent = calcMode === "basic" ? "Calculadora â€” BÃ¡sica" : "Calculadora â€” CientÃ­fica";
  toggleModeBtn.textContent = calcMode === "basic" ? "Alternar para CientÃ­fica" : "Alternar para BÃ¡sica";
}

/* FUNÃ‡ÃƒO DE AVALIAÃ‡ÃƒO "SEGURA" (substituiÃ§Ãµes) */
function safeEval(expr){
  if (!expr) return null;
  // Normalizar espaÃ§os
  let e = expr.replace(/\s+/g, "");
  // SubstituiÃ§Ãµes simples (todas as ocorrÃªncias)
  e = e.replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/%/g,'%');
  // transformar potÃªncias ^ -> **
  e = e.replace(/\^/g,'**');
  // funÃ§Ãµes e constantes mapeadas (uso Math.*)
  e = e.replace(/Ï€/g,'Math.PI');
  // Se o utilizador inseriu 'e' como constante, jÃ¡ substituÃ­mos sÃ³ quando for token Ãºnico 'e' ou apÃ³s operador.
  // Para o nosso caso do botÃ£o, inserimos 'e' como 'Math.E' directamente, mas suportamos ' e ' tambÃ©m:
  e = e.replace(/(^|[\+\-\*\/\^\(])e/g,'$1Math.E'); // cuidado para nÃ£o substituir letra em outras ocorrÃªncias
  // funÃ§Ãµes
  e = e.replace(/sqrt\(/g,'Math.sqrt(');
  e = e.replace(/âˆš\(/g,'Math.sqrt(');
  e = e.replace(/sin\(/g,'Math.sin(');
  e = e.replace(/cos\(/g,'Math.cos(');
  e = e.replace(/tan\(/g,'Math.tan(');
  e = e.replace(/ln\(/g,'Math.log(');      // ln -> natural log
  e = e.replace(/log\(/g,'Math.log10(');   // log -> base10
  // Tratar percentagens terminadas por nÃºmero: '50%' -> (50/100)
  // Mas como temos botÃ£o % que no modo bÃ¡sico transforma o display, aqui tratamos quando aparece '%' char isolado
  // Substituir nÃºmeros seguidos de % -> (num/100)
  e = e.replace(/(\d+(\.\d+)?)%/g,'($1/100)');
  // Evitar terminar com operador
  if (/[+\-*/^%\.]$/.test(e)) return null;
  try {
    // eslint-disable-next-line no-eval
    const val = eval(e);
    if (typeof val === 'number' && !Number.isFinite(val)) return null;
    if (typeof val === 'number' && !Number.isInteger(val)) return parseFloat(val.toFixed(10)).toString();
    return String(val);
  } catch (err) {
    return null;
  }
}

/* LOGICA DOS BOTÃ•ES */
function press(v){
  if (v === "C"){ display.value = ""; return; }
  if (v === "âŒ«"){ display.value = display.value.slice(0,-1); return; }
  if (v === "%"){
    // se houver um nÃºmero, aplica percentagem ao nÃºmero final
    // exemplo: "50" -> "0.5"
    // tentamos avaliar a expressÃ£o inteira primeiro
    const val = safeEval(display.value);
    if (val !== null){
      display.value = String(Number(val)/100);
    } else {
      // se falhar, tenta apenas aplicar a percentagem ao Ãºltimo nÃºmero
      display.value += "%";
    }
    return;
  }
  if (v === "="){
    const result = safeEval(display.value);
    display.value = result === null ? "Erro" : result;
    return;
  }

  // FunÃ§Ãµes cientÃ­ficas: quando o botÃ£o representa 'sin','cos','ln','sqrt','Ï€','e' etc
  const funcs = ["sin","cos","tan","ln","log","sqrt","âˆš"];
  if (funcs.includes(v)){
    if (v === "âˆš") display.value += "sqrt(";
    else display.value += v + "(";
    return;
  }
  if (v === "Ï€"){ display.value += "Ï€"; return; }
  if (v === "e"){ display.value += "Math.E"; return; } // inserimos Math.E directo para evitar ambiguidades
  // Prevenir operadores repetidos: se Ãºltimo for operador e novo tambÃ©m, substitui
  const last = display.value.slice(-1);
  const operators = "+-Ã—Ã·*/^";
  if (operators.includes(v) && operators.includes(last)){
    display.value = display.value.slice(0,-1) + v;
    return;
  }
  display.value += v;
}

/* ABRIR / FECHAR CALCULADORA (normal ou cientÃ­fica) */
function openCalc(mode="basic"){
  calcMode = mode;
  renderCalc();
  modal.style.display = "flex";
  // manter o display como estÃ¡ (nÃ£o limpar)
}
openCalcBtn.addEventListener("click", ()=> openCalc("basic"));
openSciCalcBtn.addEventListener("click", ()=> openCalc("scientific"));

function closeCalc(e){
  // clicar fora fecha
  if (e.target === modal) modal.style.display = "none";
}
closeBtn.addEventListener("click", ()=> modal.style.display = "none");

/* Alternar modo dentro da modal */
toggleModeBtn.addEventListener("click", ()=>{
  calcMode = calcMode === "basic" ? "scientific" : "basic";
  renderCalc();
});

/* ENVIAR RESULTADO â€” NÃƒO FECHAR A MODAL */
sendBtn.addEventListener("click", ()=>{
  if (!display.value || display.value === "Erro") return;
  // avaliar antes de enviar (se for expressÃ£o)
  const evaluated = safeEval(display.value);
  const toSend = evaluated === null ? display.value : evaluated;
  notes.value += `â€¢ ${toSend}\n`;
  notes.focus();
  // NÃƒO fechar modal â€” o utilizador pediu explicitamente que nÃ£o feche
});

/* COPIAR / LIMPAR / GUARDAR / APAGAR */
function copy(){ navigator.clipboard.writeText(notes.value).catch(()=>alert('NÃ£o foi possÃ­vel copiar')); }
function clearText(){ notes.value=""; }
function save(){ alert("Guardado"); }
function deleteNote(){ notes.value=""; document.getElementById("note-title").value=""; }

/* DARK MODE (guarda em localStorage) */
function applyTheme(theme){
  document.body.setAttribute("data-theme", theme);
  localStorage.setItem("pronotes-theme", theme);
  darkBtn.textContent = theme === "dark" ? "â˜€ï¸" : "ðŸŒ™";
}
darkBtn.addEventListener("click", ()=>{
  const current = document.body.getAttribute("data-theme") || "light";
  applyTheme(current === "light" ? "dark" : "light");
});
(function initTheme(){
  const saved = localStorage.getItem("pronotes-theme") || "light";
  applyTheme(saved);
})();

/* Inicializar */
renderCalc();
</script>

</body>
</html>
